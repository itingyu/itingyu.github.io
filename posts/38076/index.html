<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">

  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"itingyu.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.17.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":{"gitalk":{"order":-1}},"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="集群架构设计集群架构设计的三个维度：可用性、扩展性、一致性 可用性设计 1） 站点高可用，冗余站点 2） 服务高可用，冗余服务 3） 数据高可用，冗余数据 高可用的方案：主从模式，双主模式（分双主双写和双主单写） 扩展性设计 1） 加从库，从库过多会引发主库性能损耗。 2） 分库分表，分为垂直拆分和水平拆分，垂直拆分可以缓解部分压力，水平拆分可以无限扩展。 一致性设计 1） 不使用从库 2） 增加">
<meta property="og:type" content="article">
<meta property="og:title" content="mysql集群架构">
<meta property="og:url" content="https://itingyu.github.io/posts/38076/index.html">
<meta property="og:site_name" content="itingyu的博客">
<meta property="og:description" content="集群架构设计集群架构设计的三个维度：可用性、扩展性、一致性 可用性设计 1） 站点高可用，冗余站点 2） 服务高可用，冗余服务 3） 数据高可用，冗余数据 高可用的方案：主从模式，双主模式（分双主双写和双主单写） 扩展性设计 1） 加从库，从库过多会引发主库性能损耗。 2） 分库分表，分为垂直拆分和水平拆分，垂直拆分可以缓解部分压力，水平拆分可以无限扩展。 一致性设计 1） 不使用从库 2） 增加">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://pic4.zhimg.com/80/v2-ff30969b4cef1c5705d834f371729f3b_720w.webp">
<meta property="og:image" content="https://itingyu.github.io/posts/38076/assets/a52ebf6d575ee37e63210e54c56eddb5.webp">
<meta property="og:image" content="https://pic3.zhimg.com/80/v2-b40172df22381befa9054e11d3c42776_720w.webp">
<meta property="og:image" content="https://pic4.zhimg.com/80/v2-756a05662eff8a22e62e0cf5cf1f68eb_720w.webp">
<meta property="og:image" content="https://itingyu.github.io/posts/38076/assets/9a753dc7069250b7436af6f0aec26529.webp">
<meta property="og:image" content="https://itingyu.github.io/posts/38076/assets/8c37905765e74dc59888501e24bcbf00.webp">
<meta property="og:image" content="https://itingyu.github.io/posts/38076/assets/8d40ffd71b6bf4b7d37095257b0788cc.webp">
<meta property="og:image" content="https://itingyu.github.io/posts/38076/assets/845e02cb62de8f6318a16331b61c0c37.webp">
<meta property="og:image" content="https://itingyu.github.io/posts/38076/assets/75c03225c1e2285cecd00ee8e999578c.webp">
<meta property="og:image" content="https://pic4.zhimg.com/80/v2-2f4c9903e0bb14cb1fa9c9b59ada08f3_720w.webp">
<meta property="og:image" content="https://itingyu.github.io/posts/38076/assets/6af9eab6d58960c02dee111429128747.webp">
<meta property="og:image" content="https://itingyu.github.io/posts/38076/assets/a796cc2231d264b1f35d1f8282df1f5e.webp">
<meta property="og:image" content="https://itingyu.github.io/posts/38076/assets/1664455598527aae2dcf1a5bb18318e3.webp">
<meta property="og:image" content="https://itingyu.github.io/posts/38076/assets/8985461cb49c4205d30ff9fefc557211.webp">
<meta property="og:image" content="https://itingyu.github.io/posts/38076/assets/f5171dbd1869548e443ad7aa2136551d.webp">
<meta property="og:image" content="https://pic4.zhimg.com/80/v2-7fc309545852cd827a47aadcdf95daeb_720w.webp">
<meta property="og:image" content="https://pic2.zhimg.com/80/v2-b9fa1cb9be50e39bd097d8b9138011b9_720w.webp">
<meta property="og:image" content="https://itingyu.github.io/posts/38076/assets/05686834676076bf3e853b38e963494a.webp">
<meta property="og:image" content="https://itingyu.github.io/posts/38076/assets/380e8594b08d77dc107d124ae73260ba.webp">
<meta property="og:image" content="https://pic4.zhimg.com/80/v2-760f3e043505dec2a37a8a6f26809e03_720w.webp">
<meta property="og:image" content="https://itingyu.github.io/posts/38076/assets/03055b8ccfffb456988eb21cec0d68c7.webp">
<meta property="og:image" content="https://itingyu.github.io/posts/38076/assets/42a72128b348a6cde13865eb3405990b.webp">
<meta property="og:image" content="https://pic4.zhimg.com/80/v2-c6f56a158dfc5fde1a722d607ef62a63_720w.webp">
<meta property="og:image" content="https://pic4.zhimg.com/80/v2-b38def16fb105a6b59a2ffcf5946b24f_720w.webp">
<meta property="og:image" content="https://itingyu.github.io/posts/38076/assets/1007be3d6f8ee41b82dce780f872daa6.webp">
<meta property="og:image" content="https://pic2.zhimg.com/80/v2-9d7c5bf386053c97ffeb8960f874199d_720w.webp">
<meta property="og:image" content="https://pic3.zhimg.com/80/v2-35feebfa05d6d1756095095dfa774852_720w.webp">
<meta property="og:image" content="https://itingyu.github.io/posts/38076/assets/126597528f5be2d71df2ee91afea43ce.webp">
<meta property="og:image" content="https://pic3.zhimg.com/80/v2-194ca4fdca0a2fbf8e7a289515aa1af6_720w.webp">
<meta property="og:image" content="https://itingyu.github.io/posts/38076/assets/610fe7b6aaaba3090289e8ff706e14f1.webp">
<meta property="og:image" content="https://itingyu.github.io/posts/38076/assets/2e4620f96ab00f184602d28375735024.webp">
<meta property="og:image" content="https://pic4.zhimg.com/80/v2-3ee7ffabb5302403cb9ce88379aea797_720w.webp">
<meta property="og:image" content="https://itingyu.github.io/posts/38076/assets/a5fac8d9023c3ab3d28a1b8f150ce5e1.webp">
<meta property="og:image" content="https://pic4.zhimg.com/80/v2-223ff8107ed392104bce5500f8602897_720w.webp">
<meta property="og:image" content="https://pic4.zhimg.com/80/v2-2b3bad7b01ad32d1e8a203f1efe3498f_720w.webp">
<meta property="article:published_time" content="2023-06-17T11:10:42.000Z">
<meta property="article:modified_time" content="2023-06-17T11:13:16.000Z">
<meta property="article:author" content="itingyu">
<meta property="article:tag" content="基础知识">
<meta property="article:tag" content="mysql">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic4.zhimg.com/80/v2-ff30969b4cef1c5705d834f371729f3b_720w.webp">


<link rel="canonical" href="https://itingyu.github.io/posts/38076/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://itingyu.github.io/posts/38076/","path":"posts/38076/","title":"mysql集群架构"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>mysql集群架构 | itingyu的博客 - 记录一些琐事罢了</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
  <meta name="Robots" contect= "all">
<link rel="alternate" href="/atom.xml" title="itingyu的博客" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">itingyu的博客</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">记录一些琐事罢了</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">22</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">22</span></a></li><li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>链接</a></li><li class="menu-item menu-item-guestbook"><a href="/guestbook/" rel="section"><i class="fa fa-comment fa-fw"></i>留言板</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">1.</span> <span class="nav-text">集群架构设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E4%BB%8E%E6%A8%A1%E5%BC%8F%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">2.</span> <span class="nav-text">主从模式使用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E4%BB%8E%E6%A8%A1%E5%BC%8F%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="nav-number">3.</span> <span class="nav-text">主从模式实现原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%8A%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6"><span class="nav-number">4.</span> <span class="nav-text">半同步复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B9%B6%E8%A1%8C%E5%A4%8D%E5%88%B6"><span class="nav-number">5.</span> <span class="nav-text">并行复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL%E5%AE%89%E8%A3%85"><span class="nav-number">6.</span> <span class="nav-text">MySQL安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E5%AE%9E%E6%88%98"><span class="nav-number">7.</span> <span class="nav-text">主从同步实战</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%8A%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6%E5%AE%9E%E6%88%98"><span class="nav-number">8.</span> <span class="nav-text">半同步复制实战</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B9%B6%E8%A1%8C%E5%A4%8D%E5%88%B6%E5%AE%9E%E6%88%98"><span class="nav-number">9.</span> <span class="nav-text">并行复制实战</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="nav-number">10.</span> <span class="nav-text">读写分离</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E5%AE%9E%E6%88%98"><span class="nav-number">11.</span> <span class="nav-text">读写分离实战</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8C%E4%B8%BB%E6%A8%A1%E5%BC%8F"><span class="nav-number">12.</span> <span class="nav-text">双主模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MMM%E6%9E%B6%E6%9E%84"><span class="nav-number">13.</span> <span class="nav-text">MMM架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MHA%E6%9E%B6%E6%9E%84"><span class="nav-number">14.</span> <span class="nav-text">MHA架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MHA%E6%9E%B6%E6%9E%84%E5%AE%9E%E6%88%98"><span class="nav-number">15.</span> <span class="nav-text">MHA架构实战</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E5%A4%87%E5%88%87%E6%8D%A2%E7%AD%96%E7%95%A5"><span class="nav-number">16.</span> <span class="nav-text">主备切换策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8"><span class="nav-number">17.</span> <span class="nav-text">分库分表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E7%89%87%E7%AD%96%E7%95%A5"><span class="nav-number">18.</span> <span class="nav-text">分片策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A9%E5%AE%B9%E6%96%B9%E6%A1%88"><span class="nav-number">19.</span> <span class="nav-text">扩容方案</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="itingyu"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">itingyu</p>
  <div class="site-description" itemprop="description">记录一些编程笔记，比如编程语言java、python、go等语言;redis、rabbitmq等中间件的原理和使用等等</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">36</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/itingyu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;itingyu" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:itingyu@163.com" title="E-Mail → mailto:itingyu@163.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://itingyu.github.io/posts/38076/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="itingyu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="itingyu的博客">
      <meta itemprop="description" content="记录一些编程笔记，比如编程语言java、python、go等语言;redis、rabbitmq等中间件的原理和使用等等">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="mysql集群架构 | itingyu的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          mysql集群架构
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-06-17 19:10:42" itemprop="dateCreated datePublished" datetime="2023-06-17T19:10:42+08:00">2023-06-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" itemprop="url" rel="index"><span itemprop="name">基础知识</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>14k</span>
    </span>
</div>

        </div>
      </header>
    
    
    
    <div class="post-body" itemprop="articleBody"><h3 id="集群架构设计"><a href="#集群架构设计" class="headerlink" title="集群架构设计"></a><strong>集群架构设计</strong></h3><p>集群架构设计的三个维度：可用性、扩展性、一致性</p>
<p><strong>可用性设计</strong></p>
<p>1） 站点高可用，冗余站点</p>
<p>2） 服务高可用，冗余服务</p>
<p>3） 数据高可用，冗余数据</p>
<p>高可用的方案：主从模式，双主模式（分双主双写和双主单写）</p>
<p><strong>扩展性设计</strong></p>
<p>1） 加从库，从库过多会引发主库性能损耗。</p>
<p>2） 分库分表，分为垂直拆分和水平拆分，垂直拆分可以缓解部分压力，水平拆分可以无限扩展。</p>
<p><strong>一致性设计</strong></p>
<p>1） 不使用从库</p>
<p>2） 增加访问路由层，得到主从同步最长时间t，在数据发生修改后的t时间内，先访问主库，保证数据一致。</p>
<h3 id="主从模式使用场景"><a href="#主从模式使用场景" class="headerlink" title="主从模式使用场景"></a><strong>主从模式使用场景</strong></h3><p>数据可以从一个MySQL数据库服务器主节点复制到一个或多个从节点，默认采用异步复制方式，这样从节点不用一直访问主服务器来更新自己的数据，从节点可以复制主数据库中的所有数据库，或者特定的数据库，或者特定的表。</p>
<p><img src="https://pic4.zhimg.com/80/v2-ff30969b4cef1c5705d834f371729f3b_720w.webp" alt="img"></p>
<p><strong>主从复制用途</strong></p>
<p>1） 实时灾备，用于故障切换（高可用）</p>
<p>2） 读写分离，提供查询服务（读扩展）</p>
<p>3） 数据备份，避免影响业务（高可用）</p>
<p><strong>主从部署必要条件</strong></p>
<p>1） 从库服务器能连通主库</p>
<p>2） 主库开启binlog日志（设置log-bin参数）</p>
<p>3） 主从server-id不同</p>
<h3 id="主从模式实现原理"><a href="#主从模式实现原理" class="headerlink" title="主从模式实现原理"></a><strong>主从模式实现原理</strong></h3><p><img src="/posts/38076/assets/a52ebf6d575ee37e63210e54c56eddb5.webp" alt="img"></p>
<p>实现步骤：</p>
<p>1） 主库将数据库的变更操作记录到Binlog日志文件中</p>
<p>2） 从库读取主库中的Binlog日志文件信息写入到从库的Relay Log中继日志中</p>
<p>3） 从库读取中继日志信息在从库中进行Replay,更新从库数据信息</p>
<p>具体触发机制如下：</p>
<p>1） Master服务器对数据库更改操作记录在Binlog中，BinlogDump Thread接到写入请求后，读取 Binlog信息推送给Slave的I&#x2F;O Thread。</p>
<p>2） Slave的I&#x2F;O Thread将读取到的Binlog信息写入到本地Relay Log中。</p>
<p>3） Slave的SQL Thread检测到Relay Log的变更请求，解析relay log中内容在从库上执行。</p>
<p>存在的问题：</p>
<p>1） 主库宕机后，数据可能丢失</p>
<p>2） 从库只有一个SQL Thread，主库写压力大，复制很可能延时</p>
<p>解决的办法：</p>
<p>1） 半同步复制—解决数据丢失的问题</p>
<p>2） 并行复制—-解决从库复制延迟的问题</p>
<h3 id="半同步复制"><a href="#半同步复制" class="headerlink" title="半同步复制"></a><strong>半同步复制</strong></h3><p>从5.5开始，MySQL让Master在某一个时间点等待Slave节点的ACK消息，接收到ACK消息后才进行事务提交，这就是半同步复制。</p>
<p>主从复制时的完整过程：</p>
<p>1） InnoDB Redo File Write (Prepare Write)</p>
<p>2） Binlog File Flush &amp; Sync to Binlog File</p>
<p>3） InnoDB Redo File Commit（Commit Write）</p>
<p>4） Send Binlog to Slave</p>
<p>当Master不需要关注Slave是否接受到Binlog Event时，即为传统的主从复制。</p>
<p>当Master需要在第三步等待Slave返回ACK时，即为 after-commit，半同步复制（MySQL 5.5引入）。</p>
<p>当Master需要在第二步等待 Slave 返回 ACK 时，即为 after-sync，增强半同步（MySQL 5.7引入）。</p>
<p><img src="https://pic3.zhimg.com/80/v2-b40172df22381befa9054e11d3c42776_720w.webp" alt="img"></p>
<h3 id="并行复制"><a href="#并行复制" class="headerlink" title="并行复制"></a><strong>并行复制</strong></h3><p>MySQL从5.6版本开始追加了并行复制功能，改善复制延迟。</p>
<p><strong>5.6版本并行复制</strong></p>
<p>基于库的并行复制，也就是多线程分别执行各自库的操作，互不干扰，单库多表并发效率就不高了。</p>
<p><img src="https://pic4.zhimg.com/80/v2-756a05662eff8a22e62e0cf5cf1f68eb_720w.webp" alt="img"></p>
<p><strong>5.7版本并行复制</strong></p>
<p>基于组提交的并行复制，不再有库的并行复制限制。当事务提交时，通过在主库上的二进制日志中添加组提交信息，并将在单个操作中写入到二进制日志中。如果多个事务能同时提交成功，那么它们意味着没有冲突，因此可以在Slave上并行执行。MySQL 5.7的并行复制基于一个前提，即所有已经处于prepare阶段的事务，都是可以并行提交的。</p>
<p>InnoDB事务提交采用的是两阶段提交模式。一个阶段是prepare，另一个是commit。</p>
<p>在MySQL 5.7版本中，其设计方式是将组提交的信息存放在GTID中。为了避免用户没有开启GTID功能，MySQL 5.7又引入了称之为Anonymous_Gtid的二进制日志event类型，即日志中具有相同的last_committed，表示这些事务都在一组内。</p>
<p><strong>8.0 并行复制</strong></p>
<p>基于write-set的并行复制。有一个集合变量来存储事务修改的记录信息（主键哈希值），所有已经提交的事务所修改的主键值经过hash后都会与那个变量的集合进行对比，来判断改行是否与其冲突，并以此来确定依赖关系，没有冲突即可并行，row级别的粒度，类似于之前的表锁行锁差异，效率肯定更高。</p>
<h3 id="MySQL安装"><a href="#MySQL安装" class="headerlink" title="MySQL安装"></a><strong>MySQL安装</strong></h3><ol>
<li>上传mysql安装包到Linux服务器并进行解压</li>
</ol>
<p>tar -xvf mysql-5.7.28-1.el7.x86_64.rpm-bundle.tar</p>
<p><img src="/posts/38076/assets/9a753dc7069250b7436af6f0aec26529.webp" alt="img"></p>
<ol start="2">
<li>检查是否已有Mysql安装，存在就移除‘</li>
</ol>
<p>rpm -qa | grep mariadb</p>
<p>rpm -e mariadb-libs-5.5.41-2.el7_0.x86_64 –nodeps</p>
<ol start="3">
<li>安装mysql-community-common-5.7.28-1.el7.x86_64.rpm</li>
</ol>
<p>rpm -ivh mysql-community-common-5.7.28-1.el7.x86_64.rpm</p>
<ol start="4">
<li>安装mysql-community-libs-5.7.28-1.el7.x86_64.rpm</li>
</ol>
<p>rpm -ivh mysql-community-libs-5.7.28-1.el7.x86_64.rpm</p>
<ol start="5">
<li>安装mysql-community-libs-compat-5.7.28-1.el7.x86_64.rpm</li>
</ol>
<p>rpm -ivh mysql-community-libs-compat-5.7.28-1.el7.x86_64.rpm</p>
<p>6）安装客户端 mysql-community-client-5.7.28-1.el7.x86_64.rpm</p>
<p>rpm -ivh mysql-community-client-5.7.28-1.el7.x86_64.rpm</p>
<p>7）安装服务端mysql-community-server-5.7.28-1.el7.x86_64.rpm</p>
<p>rpm -ivh mysql-community-server-5.7.28-1.el7.x86_64.rpm</p>
<p>8）安装开发包 mysql-community-devel-5.7.28-1.el7.x86_64.rpm</p>
<p>rpm -ivh mysql-community-devel-5.7.28-1.el7.x86_64.rpm</p>
<p>9）初始化Mysql</p>
<p>mysqld –initialize –user&#x3D;mysql</p>
<p>10）查看root随机生成默认密码</p>
<p>cat &#x2F;var&#x2F;log&#x2F;mysqld.log #root@localhost: Ajtag.WsR3,J</p>
<p>11）设置自动启动Mysql</p>
<p>systemctl start mysqld.service</p>
<p>12）查看状态</p>
<p>systemctl status mysqld.service</p>
<p><img src="/posts/38076/assets/8c37905765e74dc59888501e24bcbf00.webp" alt="img"></p>
<p>13）登录Mysql</p>
<p>mysql -uroot -p # 密码：Ajtag.WsR3,J</p>
<p>14）修改数据库密码</p>
<p>set password&#x3D;password(‘root’); 修改密码</p>
<p>exit #退出</p>
<p>15）关闭服务器防火墙</p>
<p>systemctl stop iptables</p>
<p>systemctl stop firewalld</p>
<p>systemctl disable firewalld.service</p>
<p>注意1：如果安装执行出现Header V3 DSA&#x2F;SHA1 Signature, key ID 5072e1f5:错误，这是由于yum安装了旧版本的GPG keys造成的，在尾部加上–force –nodeps即可。</p>
<p><img src="/posts/38076/assets/8d40ffd71b6bf4b7d37095257b0788cc.webp" alt="img"></p>
<p>注意2：如果初始化mysql失败，执行yum -y install numactl命令</p>
<p><img src="/posts/38076/assets/845e02cb62de8f6318a16331b61c0c37.webp" alt="img"></p>
<p>注意3：如果安装完mysql之后，mysql命令登录不成功，使用yum install libncurses*命令</p>
<p><img src="/posts/38076/assets/75c03225c1e2285cecd00ee8e999578c.webp" alt="img"></p>
<h3 id="主从同步实战"><a href="#主从同步实战" class="headerlink" title="主从同步实战"></a><strong>主从同步实战</strong></h3><p>1） 修改主库my.cnf配置文件</p>
<p>执行命令vim &#x2F;etc&#x2F;my.cnf</p>
<p>log_bin&#x3D;mysql-bin #开启binlog,文件名称为mysql-bin</p>
<p>server-id&#x3D;1 #指定server-id</p>
<p>sync-binlog&#x3D;1 #执行几次后进行磁盘同步1就代表次数</p>
<p>#忽略以下库的同步</p>
<p>binlog-ignore-db&#x3D;performance_schema</p>
<p>binlog-ignore-db&#x3D;information_schema</p>
<p>binlog-ignore-db&#x3D;sys</p>
<p>#指定同步的库 不设置就是同步所有库</p>
<p>binlog-do-db&#x3D;test</p>
<p>2） 完成配置修改重启mysql</p>
<p>systemctl restart mysqld</p>
<ol>
<li>主库授权</li>
</ol>
<p>#登录MySQL</p>
<p>mysql -uroot -p</p>
<p>#主库授权设置</p>
<p>grant replication slave on <em>.</em> to ‘root‘@’%’ identified by ‘root’;</p>
<p>grant all privileges on <em>.</em> to ‘root‘@’%’ identified by ‘root’;</p>
<p>#刷新权限，立即生效</p>
<p>flush privileges;</p>
<p>#查看主库状态</p>
<p>show master status;</p>
<ol start="2">
<li>从库配置修改</li>
</ol>
<p>执行命令 vim &#x2F;etc&#x2F;my.cnf</p>
<p>server-id&#x3D;2</p>
<p>relay_log&#x3D;mysql-relay-bin #relay-log名称</p>
<p>read_only&#x3D;1 #此库只读</p>
<p>5） 完成配置修改重启mysql</p>
<p>systemctl restart mysqld</p>
<p>6） 从库启动授权</p>
<p>#登陆数据库设置复制的主库</p>
<p>change master to master_host&#x3D;’47.106.138.46’,master_port&#x3D;3306,master_user&#x3D;’root’,</p>
<p>master_password&#x3D;’root’,master_log_file&#x3D;’ master-bin.000002’,master_log_pos&#x3D;154;</p>
<p>#查看从库状态</p>
<p>show slave status \G;</p>
<p>#开启从库</p>
<p>start slave;</p>
<p>#停止从库</p>
<p>stop slave;</p>
<p>#重新绑定主库</p>
<p>reset master;</p>
<p>#主库修改配置，从库无法启动，重置</p>
<p>reset slave;</p>
<h3 id="半同步复制实战"><a href="#半同步复制实战" class="headerlink" title="半同步复制实战"></a><strong>半同步复制实战</strong></h3><p>1） 主库半同步复制设置</p>
<p>#是否支持动态加载</p>
<p>select @@have_dynamic_loading;</p>
<p><img src="https://pic4.zhimg.com/80/v2-2f4c9903e0bb14cb1fa9c9b59ada08f3_720w.webp" alt="img"></p>
<p>#查看插件列表</p>
<p>show plugins;</p>
<p><img src="/posts/38076/assets/6af9eab6d58960c02dee111429128747.webp" alt="img"></p>
<p>#安装半同步复制插件并起别名</p>
<p>install plugin rpl_semi_sync_master soname ‘semisync_master.so’;</p>
<p><img src="/posts/38076/assets/a796cc2231d264b1f35d1f8282df1f5e.webp" alt="img"></p>
<p>#查看半同步复制相关参数</p>
<p>show variables like ‘%semi%’;</p>
<p><img src="/posts/38076/assets/1664455598527aae2dcf1a5bb18318e3.webp" alt="img"></p>
<p>#开启半同步复制</p>
<p>set global rpl_semi_sync_master_enabled&#x3D;1;</p>
<p>#设置超时时间，默认10秒，设置为1秒</p>
<p>set global rpl_semi_sync_master_timeout&#x3D;1000;</p>
<p><img src="/posts/38076/assets/8985461cb49c4205d30ff9fefc557211.webp" alt="img"></p>
<p>2） 从库半同步复制设置</p>
<p>#是否支持动态加载</p>
<p>select @@have_dynamic_loading;</p>
<p><img src="/posts/38076/assets/f5171dbd1869548e443ad7aa2136551d.webp" alt="img"></p>
<p>#查看插件列表</p>
<p>show plugins;</p>
<p>#安装从库半同步复制插件并起别名</p>
<p>install plugin rpl_semi_sync_slave soname ‘semisync_slave.so’;</p>
<p>#查看半同步复制相关参数</p>
<p>show variables like ‘%semi%’;</p>
<p><img src="https://pic4.zhimg.com/80/v2-7fc309545852cd827a47aadcdf95daeb_720w.webp" alt="img"></p>
<p>#开启从库半同步复制</p>
<p>set global rpl_semi_sync_slave_enabled&#x3D;1;</p>
<p><img src="https://pic2.zhimg.com/80/v2-b9fa1cb9be50e39bd097d8b9138011b9_720w.webp" alt="img"></p>
<p>#重新加载从库</p>
<p>stop slave;</p>
<p>start slave;</p>
<p><img src="/posts/38076/assets/05686834676076bf3e853b38e963494a.webp" alt="img"></p>
<p>切换到&#x2F;var&#x2F;log目录，查看mysqld.log日志文件核验半同步复制是否生效</p>
<p><img src="/posts/38076/assets/380e8594b08d77dc107d124ae73260ba.webp" alt="img"></p>
<h3 id="并行复制实战"><a href="#并行复制实战" class="headerlink" title="并行复制实战"></a><strong>并行复制实战</strong></h3><p>1） 主库设置</p>
<p>#查看数据库组信息</p>
<p>show variables like ‘%binlog_group%’;</p>
<p><img src="https://pic4.zhimg.com/80/v2-760f3e043505dec2a37a8a6f26809e03_720w.webp" alt="img"></p>
<p>#设置延迟时间</p>
<p>set binlog_group_commit_sync_delay&#x3D;1000;</p>
<p>#设置组内事务数量</p>
<p>set binlog_group_commit_sync_no_delay_count&#x3D;100;</p>
<p>2）从库配置</p>
<p>#查看从库可设置参数</p>
<p>show variables like ‘%slave%’;</p>
<p><img src="/posts/38076/assets/03055b8ccfffb456988eb21cec0d68c7.webp" alt="img"></p>
<p>#修改并行复制方式，由库改组</p>
<p>set global slave_parallel_type&#x3D;‘LOGICAL_CLOCK’;</p>
<p>#设置组内最大线程数</p>
<p>set global slave_parallel_workers&#x3D;8;</p>
<p>#查看relay相关参数</p>
<p>show variables like ‘%relay_log%’;</p>
<p><img src="/posts/38076/assets/42a72128b348a6cde13865eb3405990b.webp" alt="img"></p>
<p>#打开relay_log写入权限</p>
<p>set global relay_log_recovery&#x3D;1;</p>
<p>#设置日志信息源为table，提高效率</p>
<p>set global relay_log_info_repository&#x3D;’TAABLE’;</p>
<p>#重启服务，使配置生效</p>
<p>systemctl restart mysqld</p>
<h3 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a><strong>读写分离</strong></h3><p>大多数互联网业务基本上读多写少，因此读写分离就可以提高读的效率，读写分离首先需要将数据库分为主从库，一个主库用于写数据，多个从库完成读数据的操作，主从库之间通过主从复制机制进行数据的同步，而且这样还可以进行主库主写，不加索引，从库主读，加索引，把两个库的效率提升到最高，不过需要解决主从同步延迟和读写分配机制。</p>
<p><img src="https://pic4.zhimg.com/80/v2-c6f56a158dfc5fde1a722d607ef62a63_720w.webp" alt="img"></p>
<p><strong>主从同步延迟</strong></p>
<p>1） 写后立刻读：在写入数据库后，某个时间段内读操作就去主库，之后读操作访问从库。</p>
<p>2） 二次查询：先去从库读取数据，找不到时就去主库进行数据读取，注意对恶意攻击限制。</p>
<p>3） 根据业务特殊处理：根据业务特点和重要程度进行调整，实时性高数据读写都在主库，其他在从库。</p>
<p><strong>读写分配机制</strong></p>
<p>控制何时去主库写，何时去从库读。</p>
<p>1） 基于编程和配置实现：根据操作类型进行路由分配，增删改时操作主库，查询时操作从库。</p>
<p>2） 基于服务器端代理实现：使用中间件代理，动态分配，常用MySQL Proxy、MyCat以及Shardingsphere等。</p>
<p><img src="https://pic4.zhimg.com/80/v2-b38def16fb105a6b59a2ffcf5946b24f_720w.webp" alt="img"></p>
<h3 id="读写分离实战"><a href="#读写分离实战" class="headerlink" title="读写分离实战"></a><strong>读写分离实战</strong></h3><p>1） 代理主机上解压mysql-proxy代理包</p>
<p>tar -xzvf mysql-proxy-0.8.5-linux-el6-x86-64bit.tar</p>
<p>2） 创建一个mysql-proxy配置文件</p>
<p>vim &#x2F;etc&#x2F;mysql-proxy.cnf</p>
<p>3） 在配置文件内写入相应配置参数</p>
<p>user&#x3D;root #运行mysql-proxy用户</p>
<p>admin-username&#x3D;root#主从mysql共有的用户</p>
<p>admin-password&#x3D;root#用户的密码</p>
<p>proxy-address&#x3D; 117.50.5.252:4040 #mysql-proxy运行ip和端口，不加端口，默认4040</p>
<p>proxy-backend-addresses&#x3D; 47.106.138.46 #指定后端主master写入数据</p>
<p>proxy-read-only-backend-addresses&#x3D; 49.235.85.246 #指定后端从slave读取数据</p>
<p>proxy-lua-script&#x3D;&#x2F;usr&#x2F;local&#x2F;mysql-proxy&#x2F;lua&#x2F;rw-splitting.lua #指定读写分离配置文件位置</p>
<p>log-file&#x3D;&#x2F;var&#x2F; logs&#x2F;mysql-proxy.log #日志位置</p>
<p>log-level&#x3D;debug #定义log日志级别，由高到低分别有(error|warning|info|message|debug)</p>
<p>daemon&#x3D;true #以守护进程方式运行</p>
<p>keepalive&#x3D;true #mysql-proxy崩溃时，尝试重启</p>
<p>#保存退出！并修改文件权限</p>
<p>chmod 660 &#x2F;etc&#x2F;mysql-porxy.cnf</p>
<p>4）修改lua脚本配置文件</p>
<p>vi &#x2F;usr&#x2F;local&#x2F;mysql-proxy&#x2F;lua&#x2F;rw-splitting.lua</p>
<p>min_idle_connections &#x3D; 1, #最小连接数，默认超过4个连接数时，才开始读写分离，改为1</p>
<p>max_idle_connections &#x3D; 8, #最大连接数，默认8</p>
<p>5）运行proxy脚本，在对应bin目录找到mysql-proxy</p>
<p>.&#x2F;mysql-proxy –defaults-file&#x3D;&#x2F;etc&#x2F;mysql-proxy.cnf</p>
<h3 id="双主模式"><a href="#双主模式" class="headerlink" title="双主模式"></a><strong>双主模式</strong></h3><p>主从模式，一主多从、读写分离，如果是单主模式，单主故障问题没法避免，是双主或者多主，增加MySQL入口，可以提升了主库的可用性，推荐使用双主单写，因为双主双写存在ID冲突和双主更新覆盖丢失问题。</p>
<p><img src="/posts/38076/assets/1007be3d6f8ee41b82dce780f872daa6.webp" alt="img"></p>
<p>双主模式实战</p>
<p>1） 修改主库1的配置</p>
<p>执行命令vim &#x2F;etc&#x2F;my.cnf</p>
<p>relay_log&#x3D;mysql-relay-bin #relay_log名称</p>
<p>log_slave_updates&#x3D;1</p>
<p>#双主双写自增主键设置 1，3，5，7… 双主单写不用设置</p>
<p>auto_increment_offset&#x3D;1 #自动递增</p>
<p>auto_increment_increment&#x3D;2 #递增量</p>
<p>2） 完成配置修改重启mysql</p>
<p>systemctl restart mysqld</p>
<p>3）修改主库2的配置</p>
<p>执行命令vim &#x2F;etc&#x2F;my.cnf</p>
<p>log_bin&#x3D;mysql-bin #开启binlog,文件名称为mysql-bin</p>
<p>server-id&#x3D;3 #指定server-id</p>
<p>sync-binlog&#x3D;1 #执行几次后进行磁盘同步 1就代表次数</p>
<p>#忽略以下库的同步</p>
<p>binlog-ignore-db&#x3D;performance_schema</p>
<p>binlog-ignore-db&#x3D;information_schema</p>
<p>binlog-ignore-db&#x3D;sys</p>
<p>relay_log&#x3D;mysql-relay-bin #relay_log名称</p>
<p>log_slave_updates&#x3D;1</p>
<p>#双主双写自增主键设置 2，4，6，8… 双主单写不用设置</p>
<p>auto_increment_offset&#x3D;2 #自动递增</p>
<p>auto_increment_increment&#x3D;2 #递增量</p>
<p>4）登陆mysql并授权</p>
<p>#主库授权设置</p>
<p>grant replication slave on <em>.</em> to ‘root‘@’%’ identified by ‘root’;</p>
<p>grant all privileges on <em>.</em> to ‘root‘@’%’ identified by ‘root’;</p>
<p>#刷新权限，立即生效</p>
<p>flush privileges;</p>
<p>5）主库1和主库2互复制设置</p>
<p>#设置复制的master1主库为master2</p>
<p>change master to master_host&#x3D;’47.106.138.46’,master_port&#x3D;3306,</p>
<p>master_user&#x3D;’root’,master_password&#x3D;’root’,master_log_file&#x3D;’mysql-bin.000004’,master_log_pos&#x3D;154;</p>
<p>#设置复制的master2主库为master1</p>
<p>change master to master_host&#x3D;’49.235.85.246’,master_port&#x3D;3306,</p>
<p>master_user&#x3D;’root’,master_password&#x3D;’root’,master_log_file&#x3D;’mysql-bin.000001’,master_log_pos&#x3D;867;</p>
<h3 id="MMM架构"><a href="#MMM架构" class="headerlink" title="MMM架构"></a><strong>MMM架构</strong></h3><p>MMM架构是管理和监控双主复制，支持双主故障切换的第三方软件。</p>
<p><img src="https://pic2.zhimg.com/80/v2-9d7c5bf386053c97ffeb8960f874199d_720w.webp" alt="img"></p>
<p><strong>MMM故障处理机制</strong></p>
<p>MMM 划分writer和reader两类角色，分别对应写节点和读节点。</p>
<p>1） 当 writer节点出现故障，程序会自动移除该节点上的VIP</p>
<p>2） 写操作切换到 Master2，并将Master2设置为writer</p>
<p>3） 将所有Slave节点会指向Master2</p>
<p>MMM 也会管理 Slave 节点，在出现宕机、复制延迟或复制错误，MMM会移除该节点的VIP，直到节点恢复正常。</p>
<p><strong>MMM监控机制</strong></p>
<p>MMM 包含monitor和agent两类程序</p>
<p>monitor：监控集群内数据库的状态，在出现异常时发布切换命令。</p>
<p>agent：运行在每个MySQL服务器上的代理进程，monitor 命令的执行者。</p>
<h3 id="MHA架构"><a href="#MHA架构" class="headerlink" title="MHA架构"></a><strong>MHA架构</strong></h3><p>MHA是一款优秀的故障切换和 主从提升的高可用软件。能30秒之内自动完成数据库的故障切换并最大保证数据一致性，并支持在线快速将Master切换到其他主机，通常只需0.5－2秒。</p>
<p><img src="https://pic3.zhimg.com/80/v2-35feebfa05d6d1756095095dfa774852_720w.webp" alt="img"></p>
<p>MHA由两部分组成：MHA Manager（管理节点）和MHA Node（数据节点）</p>
<p>MHA Manager会定时探测集群中的master节点，当master出现故障时，它可以自动将最新数据的 slave提升为新的master，然后将所有其他的slave重新指向新的master。</p>
<p><strong>MHA故障处理机制</strong></p>
<p>1） 把宕机master的binlog保存下来</p>
<p>2） 根据binlog位置点找到最新的slave</p>
<p>3） 用最新slave的relay log修复其它slave</p>
<p>4） 将保存下来的binlog在最新的slave上恢复</p>
<p>5） 将最新的slave提升为master</p>
<p>6） 将其它slave重新指向新提升的master，并开启主从复制</p>
<p><strong>MHA优点</strong></p>
<p>1） 自动故障转移快</p>
<p>2） 主库崩溃不存在数据一致性问题</p>
<p>3） 性能优秀，支持半同步复制和异步复制</p>
<p>4） 一个Manager监控节点可以监控多个集群</p>
<h3 id="MHA架构实战"><a href="#MHA架构实战" class="headerlink" title="MHA架构实战"></a><strong>MHA架构实战</strong></h3><p>1） 环境说明</p>
<p>腾讯云主机作为MHA管理，阿里云作为主服务器，华为云和Ucloud作为从服务器。</p>
<p>2） 把mha4mysql-node-0.58-0.el7.centos.noarch.rpm节点程序上传到每个服务器，在MHA管理服务器再上传mha4mysql-manager-0.58-0.el7.centos.noarch.rpm管理端程序。</p>
<p><img src="/posts/38076/assets/126597528f5be2d71df2ee91afea43ce.webp" alt="img"></p>
<p>3） 修改主库的&#x2F;etc&#x2F;my.cnf配置并重启mysql</p>
<p><img src="https://pic3.zhimg.com/80/v2-194ca4fdca0a2fbf8e7a289515aa1af6_720w.webp" alt="img"></p>
<p>4） 修改从库的&#x2F;etc&#x2F;my.cnf配置并重启mysql</p>
<p>server-id&#x3D;2</p>
<p>relay-log &#x3D; relay-log #开启中继日志</p>
<p>log-bin &#x3D; master-log #开启二进制日志</p>
<p>read_only &#x3D; ON #启用只读属性</p>
<p>relay_log_purge &#x3D; 0 #是否自动清空不再需要中继日志</p>
<p>skip_name_resolve #关闭名称解析（非必须）</p>
<p>log_slave_updates &#x3D; 1 #使得更新的数据写进二进制日志中</p>
<p>5） 重启修改配置的库，使配置生效</p>
<p>systemctl restart mysqld</p>
<p>6） 安装依赖</p>
<p>yum install perl-DBI -y</p>
<p>yum install perl-DBD-MySQL -y</p>
<p>yum install perl-Config-Tiny -y</p>
<p>yum install <a href="https://link.zhihu.com/?target=https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm">https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</a></p>
<p>yum install perl-Log-Dispatch -y</p>
<p>yum install perl-Parallel-ForkManager -y</p>
<p>7） 主、从、MHA安装node程序</p>
<p>rpm -ivh mha4mysql-node-0.58-0.el7.centos.noarch.rpm</p>
<p>8） MHA安装manager程序</p>
<p>rpm -ivh mha4mysql-manager-0.58-0.el7.centos.noarch.rpm</p>
<p>9） 四台服务器之间建立免密设置，输入第一个命令，回车然后再输入各个服务器地址命名并输入登录密码</p>
<p>#MHA 49.235.99.6</p>
<p>ssh-keygen -t rsa</p>
<p>ssh-copy-id -i &#x2F;root&#x2F;.ssh&#x2F;id_rsa <a href="mailto:&#114;&#x6f;&#111;&#116;&#64;&#52;&#x37;&#46;&#x31;&#48;&#54;&#x2e;&#49;&#51;&#56;&#x2e;&#52;&#54;">&#114;&#x6f;&#111;&#116;&#64;&#52;&#x37;&#46;&#x31;&#48;&#54;&#x2e;&#49;&#51;&#56;&#x2e;&#52;&#54;</a></p>
<p>ssh-copy-id -i &#x2F;root&#x2F;.ssh&#x2F;id_rsa <a href="mailto:&#114;&#111;&#x6f;&#116;&#x40;&#x34;&#57;&#x2e;&#x32;&#51;&#53;&#46;&#56;&#x35;&#46;&#x32;&#52;&#x36;">&#114;&#111;&#x6f;&#116;&#x40;&#x34;&#57;&#x2e;&#x32;&#51;&#53;&#46;&#56;&#x35;&#46;&#x32;&#52;&#x36;</a></p>
<p>ssh-copy-id -i &#x2F;root&#x2F;.ssh&#x2F;id_rsa <a href="mailto:&#114;&#x6f;&#111;&#x74;&#64;&#49;&#x31;&#x37;&#46;&#53;&#48;&#x2e;&#x35;&#46;&#x32;&#x35;&#50;">&#114;&#x6f;&#111;&#x74;&#64;&#49;&#x31;&#x37;&#46;&#53;&#48;&#x2e;&#x35;&#46;&#x32;&#x35;&#50;</a></p>
<p>#master 47.106.138.46</p>
<p>ssh-keygen -t rsa</p>
<p>ssh-copy-id -i &#x2F;root&#x2F;.ssh&#x2F;id_rsa <a href="mailto:&#114;&#x6f;&#111;&#116;&#64;&#52;&#x39;&#46;&#50;&#51;&#53;&#46;&#x38;&#53;&#x2e;&#50;&#52;&#54;">&#114;&#x6f;&#111;&#116;&#64;&#52;&#x39;&#46;&#50;&#51;&#53;&#46;&#x38;&#53;&#x2e;&#50;&#52;&#54;</a></p>
<p>ssh-copy-id -i &#x2F;root&#x2F;.ssh&#x2F;id_rsa <a href="mailto:&#x72;&#x6f;&#x6f;&#x74;&#64;&#49;&#x31;&#x37;&#x2e;&#x35;&#48;&#46;&#53;&#x2e;&#x32;&#x35;&#50;">&#x72;&#x6f;&#x6f;&#x74;&#64;&#49;&#x31;&#x37;&#x2e;&#x35;&#48;&#46;&#53;&#x2e;&#x32;&#x35;&#50;</a></p>
<p>#slave1 49.235.85.246</p>
<p>ssh-keygen -t rsa</p>
<p>ssh-copy-id -i &#x2F;root&#x2F;.ssh&#x2F;id_rsa <a href="mailto:&#114;&#111;&#x6f;&#x74;&#x40;&#x34;&#55;&#46;&#x31;&#x30;&#54;&#x2e;&#x31;&#51;&#56;&#x2e;&#x34;&#x36;">&#114;&#111;&#x6f;&#x74;&#x40;&#x34;&#55;&#46;&#x31;&#x30;&#54;&#x2e;&#x31;&#51;&#56;&#x2e;&#x34;&#x36;</a></p>
<p>ssh-copy-id -i &#x2F;root&#x2F;.ssh&#x2F;id_rsa <a href="mailto:&#x72;&#x6f;&#111;&#x74;&#x40;&#x31;&#49;&#55;&#46;&#x35;&#x30;&#46;&#53;&#x2e;&#x32;&#53;&#50;">&#x72;&#x6f;&#111;&#x74;&#x40;&#x31;&#49;&#55;&#46;&#x35;&#x30;&#46;&#53;&#x2e;&#x32;&#53;&#50;</a></p>
<p>#slave2 117.50.5.252</p>
<p>ssh-keygen -t rsa</p>
<p>ssh-copy-id -i &#x2F;root&#x2F;.ssh&#x2F;id_rsa <a href="mailto:&#x72;&#x6f;&#x6f;&#x74;&#64;&#x34;&#x37;&#x2e;&#49;&#48;&#x36;&#46;&#x31;&#51;&#x38;&#46;&#52;&#x36;">&#x72;&#x6f;&#x6f;&#x74;&#64;&#x34;&#x37;&#x2e;&#49;&#48;&#x36;&#46;&#x31;&#51;&#x38;&#46;&#52;&#x36;</a></p>
<p>ssh-copy-id -i &#x2F;root&#x2F;.ssh&#x2F;id_rsa <a href="mailto:root@49.235.85.246">root@49.235.85.246</a></p>
<p><img src="/posts/38076/assets/610fe7b6aaaba3090289e8ff706e14f1.webp" alt="img"></p>
<p>10）MHA配置</p>
<p>mkdir -p &#x2F;etc&#x2F;mha</p>
<p>vim &#x2F;etc&#x2F;mha&#x2F;mha.cnf</p>
<p>#下载scripts 并放到&#x2F;etc&#x2F;mha&#x2F;scripts路径下，记得给脚本加执行权限</p>
<p>下载连接：<a href="https://link.zhihu.com/?target=https://github.com/yoshinorim/mha4mysql-manager/samples/scripts">https://github.com/yoshinorim/mha4mysql-manager/samples/scripts</a></p>
<p>[server default]</p>
<p>manager_workdir&#x3D;&#x2F;etc&#x2F;mha&#x2F; #manager工作目录</p>
<p>manager_log&#x3D;&#x2F;etc&#x2F;mha&#x2F;manager.log #mananger日志</p>
<p>master_binlog_dir&#x3D;&#x2F;var&#x2F;lib&#x2F;mysql #binlog复制目录</p>
<p>user&#x3D;root</p>
<p>password&#x3D;root</p>
<p>ping_interval&#x3D;1</p>
<p>remote_workdir&#x3D;&#x2F;tmp</p>
<p>repl_password&#x3D;root</p>
<p>repl_user&#x3D;root</p>
<p>secondary_check_script&#x3D; &#x2F;usr&#x2F;bin&#x2F;masterha_secondary_check -s 49.235.85.246 -s 117.50.5.252 –user&#x3D;root –master_host&#x3D;47.106.138.46 –master_ip&#x3D;47.106.138.46 –master_port&#x3D;3306</p>
<p>master_ip_failover_script&#x3D;&#x2F;etc&#x2F;mha&#x2F;scripts&#x2F;master_ip_failover #切换脚本</p>
<p>master_ip_online_change_script&#x3D;&#x2F;etc&#x2F;mha&#x2F;scripts&#x2F;master_ip_online_change #手动switchover时候的切换</p>
<p>#shutdown_script&#x3D;””</p>
<p>ssh_user&#x3D;root</p>
<p>[server1]</p>
<p>hostname&#x3D;47.106.138.46</p>
<p>port&#x3D;3306</p>
<p>candidate_master&#x3D;1</p>
<p>check_repl_delay&#x3D;0</p>
<p>[server2]</p>
<p>hostname&#x3D;49.235.85.246</p>
<p>port&#x3D;3306</p>
<p>candidate_master&#x3D;1</p>
<p>check_repl_delay&#x3D;0</p>
<p>[server3]</p>
<p>hostname&#x3D;117.50.5.252</p>
<p>port&#x3D;3306</p>
<p>10）检查ssh连接和复制状态</p>
<p>#检查ssh免密连接</p>
<p>masterha_check_ssh –conf&#x3D;&#x2F;etc&#x2F;mha&#x2F;mha.cnf</p>
<p>#检查复制</p>
<p>masterha_check_repl –conf&#x3D;&#x2F;etc&#x2F;mha&#x2F;mha.cnf</p>
<p>11）启动Manager</p>
<p>nohup masterha_manager –conf&#x3D;&#x2F;etc&#x2F;mha&#x2F;mha.cnf&lt; &#x2F;dev&#x2F;null &gt; &#x2F;etc&#x2F;mha&#x2F;manager.log 2&gt;&amp;1 &amp;</p>
<p>12）查看状态</p>
<p>masterha_check_status –conf&#x3D;&#x2F;etc&#x2F;mha&#x2F;mha.cnf</p>
<p>13）停止Manager</p>
<p>masterha_stop –conf&#x3D;&#x2F;etc&#x2F;mha&#x2F;mha.cnf</p>
<p>rm &#x2F;etc&#x2F;mha&#x2F;&#x2F;mha.failover.complete</p>
<h3 id="主备切换策略"><a href="#主备切换策略" class="headerlink" title="主备切换策略"></a><strong>主备切换策略</strong></h3><p>主备切换是指将备库变为主库，主库变为备库，有可靠性优先和可用性优先两种策略，可靠性优先为常用。</p>
<p>主备延迟就是同一个事务，在备库执行完成的时间和主库执行完成的时间之间的差值。</p>
<p>同步延迟的原因：备库机器性能差、备库执行其他操作消耗CPU，分工问题、大事务耗时长。</p>
<p><strong>可靠性优先</strong></p>
<p>主备切换过程一般由专门的HA高可用组件完成，但是切换过程中会存在短时间不可用，为保证数据一致性。</p>
<p><strong>可用性优先</strong></p>
<p>不等主从同步完成，直接把业务请求切换至从库B ，并且让从库B可读写。</p>
<h3 id="分库分表"><a href="#分库分表" class="headerlink" title="分库分表"></a><strong>分库分表</strong></h3><p>分库分表，主要有垂直拆分和水平拆分两种拆分模式，都属于物理空间的拆分。</p>
<p>分库分表方案：只分库、只分表、分库又分表。</p>
<p>垂直拆分：由于表数量多导致的单个库大。将表拆分到多个库中。</p>
<p>水平拆分：由于表记录多导致的单个库大。将表记录拆分到多个表中。<strong>垂直拆分</strong></p>
<p>垂直拆分又称为纵向拆分，垂直拆分是将表按库进行分离，或者修改表结构按照访问的差异将某些</p>
<p>列拆分出去。</p>
<p>垂直分表就是将一张表中不常用的字段拆分到另一张表中，从而保证第一张表中的字段较少，避免 出现数据库跨页存储的问题，从而提升查询效率。</p>
<p>按业务分表</p>
<p><img src="/posts/38076/assets/2e4620f96ab00f184602d28375735024.webp" alt="img"></p>
<p>字段过多分字段</p>
<p><img src="https://pic4.zhimg.com/80/v2-3ee7ffabb5302403cb9ce88379aea797_720w.webp" alt="img"></p>
<p>优点：</p>
<p>1） 拆分后业务清晰，拆分规则明确；</p>
<p>2） 易于数据的维护和扩展；</p>
<p>3） 可以使得行数据变小，一个数据块就能存放更多的数据，在查询时就会减少 I&#x2F;O 次 数；</p>
<p>4） 可以达到最大化利用 Cache 的目的。</p>
<p>5） 便于实现冷热分离的数据表设计模式。</p>
<p>缺点：</p>
<p>1） 主键出现冗余，需要管理冗余列；</p>
<p>2） 会引起表连接 JOIN 操作，提高了系统的复杂度；</p>
<p><strong>水平拆分</strong></p>
<p>水平拆分又称为横向拆分，根据某种规则将数据分散至多个库或表中，每个表仅包含数据的一部分。</p>
<p><img src="/posts/38076/assets/a5fac8d9023c3ab3d28a1b8f150ce5e1.webp" alt="img"></p>
<p>水平拆分：解决表中记录过多问题。</p>
<p>垂直拆分：解决表过多或者是表字段过多问题。</p>
<p>优点：</p>
<p>1） 不存在单库大数据，解决高并发的性能瓶颈；</p>
<p>2） 切分的表的结构相同，应用层改造较少，只需要增加路由规则即可；</p>
<p>3） 提高了系统的稳定性和负载能力。</p>
<p>缺点：</p>
<p>1） 分片事务的一致性难以解决；</p>
<p>2） 数据扩容的难度和维护量极大。</p>
<p><strong>主键策略</strong></p>
<p>1） UUID</p>
<p>2） SNOWFLAKE(雪花算法)</p>
<p>3） 数据库ID表</p>
<p>4） Redis生成ID</p>
<h3 id="分片策略"><a href="#分片策略" class="headerlink" title="分片策略"></a><strong>分片策略</strong></h3><p>数据分片是根据指定的分片键和分片策略将数据水平拆分，拆分成多个数据片后分散到多个数据存储节点中，其实就是把原本数据打散，存在多个数据库中，他和分库分表的差异就是：分片可以制定规则，相当于逻辑，达到对应目的，而分库分表是最终的物理实现。</p>
<p><strong>基于范围分片</strong></p>
<p>根据特定字段的范围进行拆分，比如用户ID、订单时间、产品价格等。</p>
<p>优点：新的数据可以落在新的存储节点上，如果集群扩容，数据无需迁移。</p>
<p>缺点：数据热点分布不均，数据冷热不均匀，导致节点负荷不均。</p>
<p><strong>哈希取模分片</strong></p>
<p>整型的Key可直接对设备数量取模，其他类型的字段可以先计算Key的哈希值，然后再对设备数量取模。</p>
<p>优点：实现简单，数据分配比较均匀，不容易出现冷热不均，负荷不均的情况。</p>
<p>缺点：扩容时会产生大量的数据迁移，比如从n台设备扩容到n+1，绝大部分数据需要重新分配和迁移。</p>
<p><strong>一致性哈希分片</strong></p>
<p>一致性Hash是将数据按照特征值映射到一个首尾相接的Hash环上，同时也将节点（按照IP地址或者机器名Hash）映射到这个环上。对于数据，从数据在环上的位置开始，顺时针找到的第一个节 点即为数据的存储节点。</p>
<p><img src="https://pic4.zhimg.com/80/v2-223ff8107ed392104bce5500f8602897_720w.webp" alt="img"></p>
<h3 id="扩容方案"><a href="#扩容方案" class="headerlink" title="扩容方案"></a><strong>扩容方案</strong></h3><p>数据库达到承受极限时，就需要增加新服务器节点数量进行横向扩容。</p>
<p><img src="https://pic4.zhimg.com/80/v2-2b3bad7b01ad32d1e8a203f1efe3498f_720w.webp" alt="img"></p>
<p>横向扩容需要解决的问题：</p>
<p>1） 数据迁移问题</p>
<p>2） 分片规则改变</p>
<p>3） 数据同步、时间点、数据一致性</p>
<p><strong>停机扩容</strong></p>
<p>停止所有对外服务，新增n个数据库，然后写一个数据迁移程序，将原有x个库的数据导入到最新的y个库中，数据迁移完成，修改数据库服务配置，并重启所有服务。</p>
<p><strong>平滑扩容</strong></p>
<p>持续对外提供服务，保证服务的可用性，通过配置双主同步、双主双写、检测数据同步等来实现。</p>

       <div>
            
<div style="text-align:center;color: #ccc;font-size:14px;">
 ------ 本文结束感谢您的阅读 ------
</div> 

       </div>
       <div>
           <div class="reward-container">
  <div>请我一杯咖啡吧！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.jpg" alt="itingyu 微信打赏">
        <span>微信打赏</span>
      </div>

  </div>
</div>

       <div/>
    </div>

    
    
    
    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" rel="tag"><i class="fa fa-tag"></i> 基础知识</a>
              <a href="/tags/mysql/" rel="tag"><i class="fa fa-tag"></i> mysql</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/posts/33988/" rel="prev" title="mysql事务和锁相关知识">
                  <i class="fa fa-chevron-left"></i> mysql事务和锁相关知识
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/posts/18707/" rel="next" title="分库分表">
                  分库分表 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">itingyu</span>
</div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"itingyu","repo":"itingyu.github.io","client_id":"dfcd313fd692381d6bda","client_secret":"8c36e87fcf362001e3ac75ccbc34898bc8b21ac6","admin_user":"itingyu","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"en | es-ES | fr | ru | zh-CN | zh-TW","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"0425bc9934856aed10d6ec0d8dd7703a"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
